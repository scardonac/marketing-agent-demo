# Streamlit Demo - AWS Bedrock Athena Agent

## ðŸ“‹ Table of Contents
- [Overview](#overview)
- [Architecture](#architecture)
- [Features](#features)
- [Installation](#installation)
- [Configuration](#configuration)
- [Running the Application](#running-the-application)
- [How It Works](#how-it-works)
- [File Structure](#file-structure)
- [Troubleshooting](#troubleshooting)

---

## ðŸ“– Overview

This is a **Streamlit web application** that provides an interactive chat interface for communicating with AWS Bedrock Agents. Users can ask natural language questions that the agent processes using AWS Athena queries to analyze data and return insights.

**Key Capabilities:**
- ðŸ¤– Natural language conversation with AWS Bedrock Agent
- ðŸ“Š Automatic SQL query generation and execution via Athena
- ðŸ’¬ Session-based conversation memory
- ðŸ” View SQL queries generated by the agent
- âš¡ Automatic retry logic for failed requests
- ðŸ” **Secure credential management with Streamlit secrets**
- ðŸŽ¨ Clean, responsive user interface
- âš™ï¸ **Multi-source configuration** (secrets â†’ config â†’ environment â†’ manual)

---

## ðŸ—ï¸ Architecture

### Component Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Streamlit Web Interface               â”‚
â”‚                     (app.py)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            BedrockAgentClient                       â”‚
â”‚         (src/services/aws_agent_client.py)          â”‚
â”‚  - Manages AWS Bedrock Agent communication          â”‚
â”‚  - Handles streaming responses                      â”‚
â”‚  - Implements retry logic                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AWS Bedrock Agent                      â”‚
â”‚  - Processes natural language queries               â”‚
â”‚  - Generates SQL queries                            â”‚
â”‚  - Executes Athena queries                          â”‚
â”‚  - Returns formatted results                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

1. **User Input**: User types a question in the Streamlit chat interface
2. **Request Sending**: `BedrockAgentClient` sends the message to AWS Bedrock Agent with session ID
3. **Agent Processing**: Bedrock Agent interprets the question and generates appropriate SQL
4. **Query Execution**: Agent executes SQL query against AWS Athena
5. **Response Streaming**: Agent streams back results in chunks
6. **Response Formatting**: `helpers.py` formats the response for display
7. **UI Update**: Streamlit displays the formatted response to the user

---

## ðŸš€ Installation

### Prerequisites
- Python 3.8 or higher
- AWS Account with Bedrock Agent configured
- AWS credentials with appropriate permissions

### Step 1: Install Dependencies

```powershell
# Navigate to the streamlit-demo directory
cd streamlit-demo

# Install required packages
pip install -r requirements.txt
```

**Required packages:**
- `streamlit>=1.28.0` - Web framework
- `boto3>=1.34.0` - AWS SDK for Python
- `requests>=2.31.0` - HTTP library

---

## âš™ï¸ Configuration

### Option 1: Streamlit Secrets (Recommended for Production)

**For Streamlit Cloud deployment:**

1. **Go to your Streamlit Cloud app settings**
2. **Click "Secrets" in the left sidebar**
3. **Add your configuration in TOML format:**

```toml
# AWS Bedrock Agent Configuration
BEDROCK_AGENT_ID = "YOUR-ACTUAL-AGENT-ID"
BEDROCK_AGENT_ALIAS_ID = "TSTALIASID"
AWS_REGION = "us-east-1"

# AWS Authentication - Choose ONE method:
# Method 1: AWS Access Keys (recommended for Streamlit Cloud)
AWS_ACCESS_KEY_ID = "YOUR-ACTUAL-ACCESS-KEY"
AWS_SECRET_ACCESS_KEY = "YOUR-ACTUAL-SECRET-KEY"

# Method 2: AWS Profile (alternative)
# AWS_PROFILE = "your-profile-name"
```

4. **Save your secrets** - The app will automatically restart and connect

### Configuration File (Local Development)

1. **Edit the `config.py` file:**

```python
# AWS Profile (recommended)
AWS_PROFILE = "your-profile-name"  # e.g., "ai-account"

# OR use credentials directly (not both)
AWS_ACCESS_KEY_ID = "AKIA..."
AWS_SECRET_ACCESS_KEY = "your-secret-key"

# AWS Region
AWS_REGION = "us-east-1"

# Bedrock Agent Configuration
BEDROCK_AGENT_ID = "YOUR-AGENT-ID"  # Required
BEDROCK_AGENT_ALIAS_ID = "TSTALIASID"
```

2. **Save the file** - The app will automatically load these settings on startup


### Configuration Priority

The application loads configuration in this **priority order**:
1. **Streamlit secrets** (highest priority - recommended for production)
2. **config.py file** (fallback for local development)

---

## ðŸŽ® Running the Application

### Start the App

```powershell
# Make sure you're in the streamlit-demo directory
cd streamlit-demo

# Run the Streamlit app
streamlit run app.py
```

### Access the Interface

After running the command, you'll see:

```
You can now view your Streamlit app in your browser.

Local URL: http://localhost:8501
Network URL: http://192.168.1.x:8501
```

Open the URL in your browser to access the application.

### Using the Application

1. **Check Configuration Status**: Look for configuration status in the sidebar:
   - âœ… "Using Streamlit Secrets" (recommended)
   - ðŸ“„ "Using config.py file" 

2. **Verify Connection**: Check the sidebar for "âœ… Agent Connected" status

3. **Ask Questions**: Type your question in the chat input at the bottom

4. **View Results**: The agent's response appears in the conversation

5. **View SQL**: Expand "ðŸ” View SQL Query Used" to see the generated SQL

6. **New Session**: Click "ðŸ”„ New Session" to start fresh conversation

---

## ðŸ“ File Structure

```
streamlit-demo/
â”œâ”€â”€ app.py                          # Main Streamlit application
â”œâ”€â”€ config.py                       # Configuration template
â”œâ”€â”€ requirements.txt                # Python dependencies
â”œâ”€â”€ README.md                       # Project README
â”œâ”€â”€ STREAMLIT_DOCUMENTATION.md      # This file
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ aws_agent_client.py    # AWS Bedrock Agent client
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ helpers.py              # Response formatting utilities
â”‚
â””â”€â”€ static/
    â””â”€â”€ css/
        â””â”€â”€ styles.css              # Custom CSS styling
```

### Key Files Explained

#### `app.py` (670+ lines)
- **Main application logic**
- **Multi-source configuration loading** (secrets â†’ config â†’ environment)
- Streamlit page configuration
- User interface components
- Message handling and display
- Session state management

**Key Functions:**
- `load_configuration()` - Loads config from multiple sources with priority
- `get_config_source()` - Determines which config source is active
- `initialize_agent_client()` - Sets up AWS Bedrock connection
- `extract_sql_query_from_trace()` - Extracts SQL from agent traces
- `main()` - Main application loop with configuration status display

#### `src/services/aws_agent_client.py` (259 lines)
- **AWS Bedrock Agent communication**
- Boto3 client initialization
- Request/response handling
- Retry logic implementation

#### `src/utils/helpers.py` (218 lines)
- **Response formatting utilities**
- Table data parsing
- Text cleaning
- AWS credentials validation

**Key Functions:**
- `format_response(response_data)` - Formats agent responses
- `clean_response_text(text)` - Cleans up text formatting
- `extract_table_from_response(text)` - Parses markdown tables
- `validate_aws_credentials()` - Validates AWS credential format

#### `config.py`
- **Configuration template**
- AWS credentials
- Agent IDs
- Application settings

---

## ðŸ› Troubleshooting

### Common Issues

#### 1. **Import Error: "streamlit not found"**

**Problem:** Streamlit not installed

**Solution:**
```powershell
pip install streamlit>=1.28.0
```

#### 2. **Connection Error: "Invalid AWS credentials"**

**Problem:** Incorrect or missing AWS credentials

**Solution:**
- **First**: Check configuration status in sidebar - see which source is being used
- **For Streamlit secrets**: Verify secrets in Streamlit Cloud dashboard or `.streamlit/secrets.toml`
- **For config.py**: Verify credentials in `config.py`
- **For environment**: Check AWS profile configuration
- Ensure credentials have Bedrock permissions

```powershell
# Test AWS credentials
aws sts get-caller-identity --profile your-profile-name

# Or test specific credentials
aws sts get-caller-identity --region us-east-1
```

#### 3. **Timeout Errors**

**Problem:** Agent taking too long to respond

**Solutions:**
- Simplify your question
- Break complex queries into parts
- Check AWS Bedrock service status
- Verify Athena query performance

**Current timeout settings:**
- Read timeout: 300 seconds (5 minutes)
- Connect timeout: 90 seconds
- Retry attempts: 3

#### 4. **Agent Not Found Error**

**Problem:** Incorrect Agent ID or Alias ID

**Solution:**
```powershell
# List available agents
aws bedrock-agent list-agents --region us-east-1

# Verify agent alias
aws bedrock-agent list-agent-aliases --agent-id YOUR-AGENT-ID --region us-east-1
```

#### 5. **CSS Not Loading**

**Problem:** Custom styles not applied

**Solution:**
- Verify `static/css/styles.css` exists
- Check file path in `app.py`
- Clear browser cache

### Debug Mode

Enable debug mode in `config.py`:

```python
DEBUG_MODE = True
```

This provides additional logging in the console.

#### 6. **Configuration Source Issues**

**Problem:** Not sure which configuration is being used

**Solution:**
- Check the **"âš™ï¸ Configuration Status"** section in the sidebar
- Look for status indicators:
  - âœ… "Using Streamlit Secrets" - Secure, recommended
  - ðŸ“„ "Using config.py file" - Local development
  - ðŸŒ "Using environment variables" - System-level
  - âš ï¸ "No configuration found" - Need to configure

**Troubleshooting config priority:**
1. Streamlit secrets always take precedence
2. If secrets exist but show as "config.py", check secrets format
3. Use the **"ðŸ”§ How to use Streamlit Secrets"** expander for setup help

### Session Management Issues

**Reset session:**
1. Click "ðŸ”„ New Session" button in the interface
2. Or restart the Streamlit app

**Clear all data:**
```powershell
# Stop the app (Ctrl+C)
# Delete Streamlit cache
streamlit cache clear
```
---

## ðŸ“Š Performance Tips

### Optimize Query Performance

1. **Be specific in questions**
   - Include time ranges: "in 2024" vs "ever"
   - Specify limits: "top 10" vs "all"

2. **Use filters**
   - "with at least 500 records"
   - "where engagement rate > 5%"

3. **Break down complex questions**
   - Instead of: "Show me all metrics for all creatives"
   - Use: "Show me top 5 creatives by engagement"

### Application Performance

1. **Session history limit**
   - Default: 50 messages
   - Adjust in `config.py`: `MAX_CHAT_HISTORY = 50`

2. **Connection pooling**
   - Reuses AWS client connections
   - Reduces initialization overhead
