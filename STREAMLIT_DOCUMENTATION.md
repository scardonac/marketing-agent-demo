# Streamlit Demo - AWS Bedrock Athena Agent

## üìã Table of Contents
- [Overview](#overview)
- [Architecture](#architecture)
- [Features](#features)
- [Installation](#installation)
- [Configuration](#configuration)
- [Running the Application](#running-the-application)
- [How It Works](#how-it-works)
- [File Structure](#file-structure)
- [Troubleshooting](#troubleshooting)

---

## üìñ Overview

This is a **Streamlit web application** that provides an interactive chat interface for communicating with AWS Bedrock Agents. Users can ask natural language questions that the agent processes using AWS Athena queries to analyze data and return insights.

**Key Capabilities:**
- ü§ñ Natural language conversation with AWS Bedrock Agent
- üìä Automatic SQL query generation and execution via Athena
- üí¨ Session-based conversation memory
- üîç View SQL queries generated by the agent
- ‚ö° Automatic retry logic for failed requests
- üé® Clean, responsive user interface

---

## üèóÔ∏è Architecture

### Component Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               Streamlit Web Interface               ‚îÇ
‚îÇ                     (app.py)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            BedrockAgentClient                       ‚îÇ
‚îÇ         (src/services/aws_agent_client.py)          ‚îÇ
‚îÇ  - Manages AWS Bedrock Agent communication          ‚îÇ
‚îÇ  - Handles streaming responses                      ‚îÇ
‚îÇ  - Implements retry logic                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              AWS Bedrock Agent                      ‚îÇ
‚îÇ  - Processes natural language queries               ‚îÇ
‚îÇ  - Generates SQL queries                            ‚îÇ
‚îÇ  - Executes Athena queries                          ‚îÇ
‚îÇ  - Returns formatted results                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Data Flow

1. **User Input**: User types a question in the Streamlit chat interface
2. **Request Sending**: `BedrockAgentClient` sends the message to AWS Bedrock Agent with session ID
3. **Agent Processing**: Bedrock Agent interprets the question and generates appropriate SQL
4. **Query Execution**: Agent executes SQL query against AWS Athena
5. **Response Streaming**: Agent streams back results in chunks
6. **Response Formatting**: `helpers.py` formats the response for display
7. **UI Update**: Streamlit displays the formatted response to the user

---

## ‚ú® Features

### 1. **Conversational AI Interface**
- Ask questions in natural language
- Maintains conversation context within each session
- Session IDs enable follow-up questions

### 2. **AWS Integration**
- Direct integration with AWS Bedrock Agents
- Supports multiple authentication methods (credentials, profiles)
- Configurable regions and agent IDs

### 3. **SQL Query Visibility**
- View the exact SQL queries generated by the agent
- Learn how the agent interprets your questions
- Copy queries for use in other tools

### 4. **Robust Error Handling**
- Automatic retry logic for timeout errors
- Clear error messages with troubleshooting tips
- Extended timeout settings (2 minutes)

### 5. **User-Friendly Interface**
- Example questions in sidebar
- Conversation history with timestamps
- Session management (new session button)
- Progress indicators during processing

---

## üöÄ Installation

### Prerequisites
- Python 3.8 or higher
- AWS Account with Bedrock Agent configured
- AWS credentials with appropriate permissions

### Step 1: Install Dependencies

```powershell
# Navigate to the streamlit-demo directory
cd streamlit-demo

# Install required packages
pip install -r requirements.txt
```

**Required packages:**
- `streamlit>=1.28.0` - Web framework
- `boto3>=1.34.0` - AWS SDK for Python
- `requests>=2.31.0` - HTTP library

---

## ‚öôÔ∏è Configuration

### Option 1: Configuration File (Recommended)

1. **Edit the `config.py` file:**

```python
# AWS Profile (recommended)
AWS_PROFILE = "your-profile-name"  # e.g., "ai-account"

# OR use credentials directly (not both)
AWS_ACCESS_KEY_ID = "AKIA..."
AWS_SECRET_ACCESS_KEY = "your-secret-key"

# AWS Region
AWS_REGION = "us-east-1"

# Bedrock Agent Configuration
BEDROCK_AGENT_ID = "YOUR-AGENT-ID"  # Required
BEDROCK_AGENT_ALIAS_ID = "TSTALIASID"
```

2. **Save the file** - The app will automatically load these settings on startup

### Option 2: Environment Variables

**PowerShell:**
```powershell
$env:BEDROCK_AGENT_ID = "YOUR-AGENT-ID"
$env:BEDROCK_AGENT_ALIAS_ID = "TSTALIASID"
$env:AWS_DEFAULT_REGION = "us-east-1"
$env:AWS_PROFILE = "your-profile-name"

# OR use credentials
$env:AWS_ACCESS_KEY_ID = "AKIA..."
$env:AWS_SECRET_ACCESS_KEY = "your-secret-key"
```

### Configuration Priority

The application loads configuration in this order:
1. `config.py` file (if exists)
2. Environment variables (if config.py not found)
3. Manual entry in web interface (if neither above exists)

---

## üéÆ Running the Application

### Start the App

```powershell
# Make sure you're in the streamlit-demo directory
cd streamlit-demo

# Run the Streamlit app
streamlit run app.py
```

### Access the Interface

After running the command, you'll see:

```
You can now view your Streamlit app in your browser.

Local URL: http://localhost:8501
Network URL: http://192.168.1.x:8501
```

Open the URL in your browser to access the application.

### Using the Application

1. **Verify Connection**: Check the sidebar for "‚úÖ Agent Connected" status
2. **Ask Questions**: Type your question in the chat input at the bottom
3. **View Results**: The agent's response appears in the conversation
4. **View SQL**: Expand "üîç View SQL Query Used" to see the generated SQL
5. **New Session**: Click "üîÑ New Session" to start fresh conversation

---

## üîß How It Works

### Session Management

```python
# Each user session gets a unique ID
session_id = f"streamlit-chat-{uuid.uuid4().hex[:8]}"
```

This ID is passed with every message, enabling:
- Conversation context tracking
- Follow-up questions understanding
- Session isolation between users

### Message Sending Flow

```python
# 1. User sends message
response = agent_client.send_message(
    message=prompt,
    session_id=st.session_state.session_id
)

# 2. Agent processes with retry logic
for attempt in range(max_retries + 1):
    try:
        response = bedrock_agent_runtime.invoke_agent(
            agentId=agent_id,
            agentAliasId=agent_alias_id,
            sessionId=session_id,
            inputText=message
        )
        # Process streaming response
        break
    except TimeoutError:
        if attempt < max_retries:
            wait_and_retry()

# 3. Response formatted and displayed
formatted = format_response(response)
st.markdown(formatted["text"])
```

### SQL Query Extraction

The app extracts SQL queries from the agent's trace data:

```python
def extract_sql_query_from_trace(trace_data):
    # Searches nested structure for SQL queries
    # Looks in: invocationInput -> actionGroupInvocationInput -> 
    #           requestBody -> content -> application/json
    # Returns cleaned SQL query
```

### Response Processing

```python
def _process_streaming_response(response):
    full_text = ""
    for event in event_stream:
        if 'chunk' in event:
            chunk_text = event['chunk']['bytes'].decode('utf-8')
            full_text += chunk_text
        elif 'trace' in event:
            trace_data.append(event['trace'])
    return {
        "text": full_text,
        "trace_data": trace_data
    }
```

---

## üìÅ File Structure

```
streamlit-demo/
‚îú‚îÄ‚îÄ app.py                          # Main Streamlit application
‚îú‚îÄ‚îÄ config.py                       # Configuration template
‚îú‚îÄ‚îÄ requirements.txt                # Python dependencies
‚îú‚îÄ‚îÄ README.md                       # Project README
‚îú‚îÄ‚îÄ STREAMLIT_DOCUMENTATION.md      # This file
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ aws_agent_client.py    # AWS Bedrock Agent client
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ helpers.py              # Response formatting utilities
‚îÇ
‚îî‚îÄ‚îÄ static/
    ‚îî‚îÄ‚îÄ css/
        ‚îî‚îÄ‚îÄ styles.css              # Custom CSS styling
```

### Key Files Explained

#### `app.py` (570 lines)
- **Main application logic**
- Streamlit page configuration
- User interface components
- Message handling and display
- Session state management

**Key Functions:**
- `initialize_agent_client()` - Sets up AWS Bedrock connection
- `extract_sql_query_from_trace()` - Extracts SQL from agent traces
- `main()` - Main application loop

#### `src/services/aws_agent_client.py` (259 lines)
- **AWS Bedrock Agent communication**
- Boto3 client initialization
- Request/response handling
- Retry logic implementation

**Key Class: `BedrockAgentClient`**
```python
class BedrockAgentClient:
    def __init__(agent_id, agent_alias_id, region, credentials)
    def send_message(message, session_id, max_retries)
    def _process_streaming_response(response)
    def _test_connection()
```

#### `src/utils/helpers.py` (218 lines)
- **Response formatting utilities**
- Table data parsing
- Text cleaning
- AWS credentials validation

**Key Functions:**
- `format_response(response_data)` - Formats agent responses
- `clean_response_text(text)` - Cleans up text formatting
- `extract_table_from_response(text)` - Parses markdown tables
- `validate_aws_credentials()` - Validates AWS credential format

#### `config.py`
- **Configuration template**
- AWS credentials
- Agent IDs
- Application settings

---

## üêõ Troubleshooting

### Common Issues

#### 1. **Import Error: "streamlit not found"**

**Problem:** Streamlit not installed

**Solution:**
```powershell
pip install streamlit>=1.28.0
```

#### 2. **Connection Error: "Invalid AWS credentials"**

**Problem:** Incorrect or missing AWS credentials

**Solution:**
- Verify credentials in `config.py`
- Check AWS profile configuration
- Ensure credentials have Bedrock permissions

```powershell
# Test AWS credentials
aws sts get-caller-identity --profile your-profile-name
```

#### 3. **Timeout Errors**

**Problem:** Agent taking too long to respond

**Solutions:**
- Simplify your question
- Break complex queries into parts
- Check AWS Bedrock service status
- Verify Athena query performance

**Current timeout settings:**
- Read timeout: 300 seconds (5 minutes)
- Connect timeout: 90 seconds
- Retry attempts: 3

#### 4. **Agent Not Found Error**

**Problem:** Incorrect Agent ID or Alias ID

**Solution:**
```powershell
# List available agents
aws bedrock-agent list-agents --region us-east-1

# Verify agent alias
aws bedrock-agent list-agent-aliases --agent-id YOUR-AGENT-ID --region us-east-1
```

#### 5. **CSS Not Loading**

**Problem:** Custom styles not applied

**Solution:**
- Verify `static/css/styles.css` exists
- Check file path in `app.py`
- Clear browser cache

### Debug Mode

Enable debug mode in `config.py`:

```python
DEBUG_MODE = True
```

This provides additional logging in the console.

### Session Management Issues

**Reset session:**
1. Click "üîÑ New Session" button in the interface
2. Or restart the Streamlit app

**Clear all data:**
```powershell
# Stop the app (Ctrl+C)
# Delete Streamlit cache
streamlit cache clear
```

---

## üîí Security Best Practices

1. **Never commit credentials** to version control
   - Add `config.py` to `.gitignore` if it contains real credentials
   - Use environment variables or AWS profiles

2. **Use AWS IAM roles** when possible
   - Preferred over access keys
   - Better audit trail

3. **Limit permissions**
   - Grant only necessary Bedrock and Athena permissions
   - Use least privilege principle

4. **Rotate credentials regularly**
   - Change access keys periodically
   - Monitor AWS CloudTrail for unusual activity

---

## üìä Performance Tips

### Optimize Query Performance

1. **Be specific in questions**
   - Include time ranges: "in 2024" vs "ever"
   - Specify limits: "top 10" vs "all"

2. **Use filters**
   - "with at least 500 records"
   - "where engagement rate > 5%"

3. **Break down complex questions**
   - Instead of: "Show me all metrics for all creatives"
   - Use: "Show me top 5 creatives by engagement"

### Application Performance

1. **Session history limit**
   - Default: 50 messages
   - Adjust in `config.py`: `MAX_CHAT_HISTORY = 50`

2. **Connection pooling**
   - Reuses AWS client connections
   - Reduces initialization overhead

---

## üöÄ Advanced Usage

### Custom Agent Configuration

To use a different Bedrock Agent:

```python
# In config.py
BEDROCK_AGENT_ID = "YOUR-OTHER-AGENT-ID"
BEDROCK_AGENT_ALIAS_ID = "PRODALIASID"  # or custom alias
```

### Multi-Region Support

```python
# In config.py
AWS_REGION = "eu-west-1"  # Change to your region
```

Supported regions: Any AWS region with Bedrock Agent support

### Extending Functionality

To add new features:

1. **Add helper functions** in `src/utils/helpers.py`
2. **Extend agent client** in `src/services/aws_agent_client.py`
3. **Update UI** in `app.py`

Example - Add response export:

```python
# In helpers.py
def export_response_to_csv(response_data):
    import csv
    # Implementation here
    
# In app.py
if st.button("Export to CSV"):
    csv_data = export_response_to_csv(response)
    st.download_button("Download", csv_data, "response.csv")
```

---

## üìù Development Notes

### Code Style
- Python 3.8+ features used
- Type hints for better IDE support
- Docstrings for all public functions

### Testing
To test the application:

```powershell
# Test AWS connection
python -c "import boto3; print(boto3.Session().get_credentials())"

# Test Streamlit
streamlit hello
```

### Dependencies Management

Update dependencies:
```powershell
pip install --upgrade streamlit boto3 requests
pip freeze > requirements.txt
```

---

## ü§ù Support

For issues or questions:

1. Check this documentation
2. Review error messages in the app
3. Check AWS Bedrock Agent configuration
4. Verify Athena query permissions

---

## üìÑ License

This application is part of the AWS Bedrock Athena Agent project.

---

**Last Updated:** October 28, 2025  
**Version:** 1.0  
**Maintained by:** PayLink Development Team
